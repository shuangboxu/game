<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>äººæµèº²é¿å°æ¸¸æˆ</title>
  <style>
    body { text-align: center; background: #f4f4f4; }
    canvas { background: white; border: 2px solid #333; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>ğŸš‡ äººæµèº²é¿æˆ˜</h2>
  <!-- ğŸ‘‡ è¿™é‡Œå¯ä»¥æ”¹ç”»å¸ƒé«˜åº¦ï¼Œæ¯”å¦‚æ”¹æˆ 300ã€400 éƒ½è¡Œ -->
  <canvas id="gameCanvas" width="400" height="400"></canvas>
  <p id="status"></p>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // ç©å®¶
    const player = {
      x: canvas.width / 2,
      y: canvas.height - 50,
      radius: 15,
      color: "blue",
      speed: 3 // æ¯æ¬¡æŒ‰é”®ç§»åŠ¨æ›´çµæ•
    };

    let enemies = [];
    let gameOver = false;
    let spawnRate = 40; // æ•Œäººç”Ÿæˆé—´éš”60
    let frameCount = 0;

    // æ¸¸æˆè¿è¡Œæ—¶é•¿ï¼ˆå›ºå®š 30 ç§’ï¼‰
    let gameTime = 10;
    // è¿Ÿåˆ°è®¡æ—¶è¡¨ï¼ˆåˆå§‹ 30 ç§’ï¼Œç¢°åˆ°çº¢çƒ +10ï¼‰
    let lateTime = 30;
    let gameStarted = false;
    let timerInterval;

    // é”®ç›˜æ§åˆ¶
    let keys = {};
    document.addEventListener("keydown", e => keys[e.key] = true);
    document.addEventListener("keyup", e => keys[e.key] = false);

    // é¼ æ ‡æ§åˆ¶
    canvas.addEventListener("mousemove", e => {
      const rect = canvas.getBoundingClientRect();
      player.x = e.clientX - rect.left;
    });

    function drawPlayer() {
      ctx.beginPath();
      ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
      ctx.fillStyle = player.color;
      ctx.fill();
      ctx.closePath();
    }

    function drawEnemies() {
      enemies.forEach(e => {
        ctx.beginPath();
        ctx.arc(e.x, e.y, e.radius, 0, Math.PI * 2);
        ctx.fillStyle = e.color;
        ctx.fill();
        ctx.closePath();
      });
    }

    function updateEnemies() {
      enemies.forEach(e => e.y += e.speed);
      enemies = enemies.filter(e => e.y < canvas.height + e.radius);
    }

    function spawnEnemy() {
      const radius = 12;
      const x = Math.random() * (canvas.width - radius * 2) + radius;
      enemies.push({ x, y: -radius, radius, color: "red", speed: 3 });
    }

    function checkCollision() {
      for (let e of enemies) {
        let dx = e.x - player.x;
        let dy = e.y - player.y;
        let dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < e.radius + player.radius) {
          // æ’åˆ°çº¢çƒ -> è¿Ÿåˆ°è®¡æ—¶è¡¨ +10 ç§’
          lateTime += 10;
          enemies.splice(enemies.indexOf(e), 1); // åˆ é™¤è¢«æ’çš„çƒ
        }
      }
    }

    function updatePlayer() {
      if (keys["ArrowLeft"] && player.x - player.radius > 0) {
        player.x -= player.speed;
      }
      if (keys["ArrowRight"] && player.x + player.radius < canvas.width) {
        player.x += player.speed;
      }
    }

    function drawTimer() {
      ctx.font = "16px Arial";
      ctx.fillStyle = "black";
      ctx.fillText("æ¸¸æˆå‰©ä½™: " + gameTime + " ç§’", 20, 30);
      ctx.fillText("è¿Ÿåˆ°è®¡æ—¶: " + lateTime + " ç§’", 20, 55);
    }

function endGame() {
  gameOver = true;
  clearInterval(timerInterval);

  let msg;
  if (lateTime >= 90) {
    msg = "âŒ æ²¡èµ¶ä¸Šç«è½¦ï¼ˆè¿Ÿåˆ° " + lateTime + " ç§’ï¼‰";
  } else {
    msg = "âœ… æˆåŠŸèµ¶ä¸Šç«è½¦ï¼ï¼ˆè¿Ÿåˆ° " + lateTime + " ç§’ï¼‰";
  }
  document.getElementById("status").innerText = msg;

  // ===== æ–°å¢ï¼šæŠŠç»“æœä¼ å›ä¸»ç¨‹åº =====
  if (window.opener && window.opener.applyMiniGameResult) {
    window.opener.applyMiniGameResult(lateTime);
  }
  // è‡ªåŠ¨å…³é—­å°æ¸¸æˆçª—å£
  setTimeout(() => window.close(), 2000);
}


    function gameLoop() {
      if (gameOver) return;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      updatePlayer();
      updateEnemies();

      frameCount++;
      if (frameCount % spawnRate === 0) {
        spawnEnemy();
        if (spawnRate > 10) spawnRate--; // æ•Œäººè¶Šæ¥è¶Šå¤š15
      }

      checkCollision();

      drawPlayer();
      drawEnemies();
      drawTimer();

      requestAnimationFrame(gameLoop);
    }

    function startGame() {
      alert(
  "ğŸš‡ã€äººæµèº²é¿å°æ¸¸æˆã€‘\n\n" +
  "åœºæ™¯ï¼šä¸‹ç­é«˜å³°ï¼ŒåŒ—äº¬åœ°é“ç«™äººå±±äººæµ·ï¼\n" +
  "ä½ å°±æ˜¯é‚£ä¸ªæ€¥ç€èµ¶ç«è½¦çš„è€ƒç”Ÿï¼Œå°è“çƒ = ä½ ï¼Œçº¢è‰²å°çƒ = ä¸‹ç­å›å®¶çš„äººã€‚\n\n" +
  "ç©æ³•ï¼š\n" +
  "- ç”¨é¼ æ ‡ç§»åŠ¨ æˆ– â† â†’ æ–¹å‘é”®æ§åˆ¶å°è“çƒå·¦å³é—ªé¿\n" +
  "- æ¸¸æˆè¿è¡Œæ—¶é—´ï¼š10 ç§’\n" +
  "- å±å¹•å³ä¸Šè§’æ˜¾ç¤ºçš„æ˜¯ã€è¿Ÿåˆ°è®¡æ—¶ã€‘ï¼ˆåˆå§‹ 30 ç§’ï¼‰\n" +
  "- æ¯æ¬¡è¢«çº¢çƒæ’ä¸Šï¼Œä½ å°±åœ¨äººç¾¤é‡Œè¢«ç»Šä½ï¼š+10 ç§’è¿Ÿåˆ°\n\n" +
  "ç›®æ ‡ï¼š\n" +
  "å°½é‡å°‘æ’äººï¼\n\n" +
  "ç°åœ¨æ·±å‘¼å¸ï¼Œå‡†å¤‡å†²è¿›äººæµå§ï¼ğŸš€"
);

      gameStarted = true;

      // å€’è®¡æ—¶é€»è¾‘ï¼ˆæ¸¸æˆåªè·‘30ç§’ï¼‰
      timerInterval = setInterval(() => {
        if (gameTime > 0) {
          gameTime--;
        } else {
          endGame();
        }
      }, 1000);

      gameLoop();
    }

    // å¼€å§‹æ¸¸æˆ
    startGame();
    
  </script>
</body>
</html>

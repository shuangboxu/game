<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>12306 抢票</title>
  <meta name="viewport" content="width=500, initial-scale=1" />
  <style>
    :root {
      --blue: #1e80ff;
      --gray: #f5f7fa;
      --text: #2b2f36;
      --muted: #6b7280;
      --ok: #16a34a;
      --bad: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
      background: white; color: var(--text);
    }
    header {
      padding: 14px 16px; border-bottom: 1px solid #eef2f7; font-weight: 600;
    }
    .bar {
      display: flex; align-items: center; gap: 8px;
      padding: 12px 16px; background: var(--gray); font-size: 14px;
    }
    .pill { padding: 2px 8px; border-radius: 999px; background: white; border: 1px solid #e5e7eb; }
    .row {
      display: grid; grid-template-columns: 1fr auto auto auto; gap: 16px;
      padding: 16px; border-bottom: 1px solid #eef2f7; align-items: center;
    }
    .time { font-size: 22px; font-weight: 700; }
    .station { font-size: 12px; color: var(--muted); }
    .price { font-weight: 600; }
    .stock.ok { color: var(--ok); font-weight: 600; }
    .stock.bad { color: var(--bad); font-weight: 600; }
    .btn {
      padding: 10px 16px; border-radius: 8px; border: 0; background: var(--blue);
      color: white; cursor: pointer; font-weight: 600; font-size: 14px;
    }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }
    .hint { font-size: 12px; color: var(--muted); margin: 8px 16px 0; }
    .count { font-variant-numeric: tabular-nums; font-weight: 700; }
    .toast {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 16px; background: rgba(0,0,0,.8); color: #fff; padding: 10px 14px;
      border-radius: 8px; font-size: 14px; display: none;
    }
  </style>
</head>
<body>
  <header>12306 列车查询</header>

  <div class="bar">
    <span class="pill">放票倒计时：<span id="cd" class="count">3</span>s</span>
    <span class="pill">规则：放票后“<b>预定</b>”会启用，请尽快点击</span>
  </div>
  <div class="hint">提示：慢 1~3 秒可能就「无票」；成功会把你的耗时（秒）回传主页面。</div>

  <div class="row">
    <div>
      <div class="time">18:40 <span class="station">过 北京西</span></div>
      <div class="time">19:06 <span class="station">终 良乡</span></div>
    </div>
    <div class="price">￥6 <span class="station">起</span></div>
    <div id="stock" class="stock ok">无座 有票</div>
    <div>
      <button id="bookBtn" class="btn" disabled>预定</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // 页面加载就提示规则
   alert(
  "🚄【12306 抢票大战】\n\n" +
  "场景：北京西站 → 良乡站，黄金车次 18:40 - 19:06。\n" +
  "票价只要 ￥6，但下班高峰，抢票的人山人海！\n\n" +
  "玩法：\n" +
  "- 系统会在放票时启用『预定』按钮\n" +
  "- 你必须第一时间点下『预定』！\n" +
  "- 慢 1~3 秒，票可能就被别人秒光\n\n" +
  "提示：\n" +
  "手速与眼力，就是你能不能上火车的关键！🔥\n\n" +
  "准备好了吗？\n"
);

    // —— 可调参数 —— //
    const PRE_OPEN_COUNTDOWN = 3;   // 放票前倒计时秒数（展示用）
    const SELL_OUT_AFTER_MIN = 0.8; // 放票后最早售罄(秒)
    const SELL_OUT_AFTER_MAX = 2.5; // 放票后最晚售罄(秒)

    // —— 运行状态 —— //
    let tStartOpen = null;      // 放票开始时刻(ms)
    let soldOutAt = null;       // 售罄的绝对时间(ms)
    let opened = false;         // 是否已放票
    const btn = document.getElementById('bookBtn');
    const stockEl = document.getElementById('stock');
    const cdEl = document.getElementById('cd');
    const toast = document.getElementById('toast');

    function showToast(msg) {
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(()=> toast.style.display='none', 1500);
    }

    // 放票倒计时
    let remain = PRE_OPEN_COUNTDOWN;
    cdEl.textContent = remain;
    const cdTimer = setInterval(()=>{
      remain--;
      cdEl.textContent = Math.max(0, remain);
      if (remain <= 0) {
        clearInterval(cdTimer);
        openSale();
      }
    }, 1000);

    function openSale() {
      opened = true;
      btn.disabled = false;
      tStartOpen = Date.now();
      // 随机一个售罄时间窗口
      const delta = (SELL_OUT_AFTER_MIN + Math.random() * (SELL_OUT_AFTER_MAX - SELL_OUT_AFTER_MIN)) * 1000;
      soldOutAt = tStartOpen + delta;

      // 看门人：到点自动售罄
      const checkTimer = setInterval(()=>{
        if (!opened) return clearInterval(checkTimer);
        if (Date.now() >= soldOutAt) {
          // 自动售罄
          toSoldOutUI();
          // 如果还没点就失败，返回 99999
          tryReturnFail();
          clearInterval(checkTimer);
        }
      }, 30);
    }

    function toSoldOutUI() {
      stockEl.textContent = '无座 无票';
      stockEl.classList.remove('ok');
      stockEl.classList.add('bad');
      btn.disabled = true;
    }

    // 用户点击“预定”
    btn.addEventListener('click', ()=>{
      if (!opened) return;
      const now = Date.now();
      if (now >= soldOutAt) {
        toSoldOutUI();
        showToast('慢了一步，已售罄！');
        tryReturnFail();
        return;
      }
      // 成功：回传耗时（向上取整）
      const spentSec = Math.max(0, Math.ceil((now - tStartOpen) / 1000));
      showToast('预定成功，耗时 '+ spentSec +' 秒');
      safeReturn(spentSec);
    });

    // 失败回传
// 自动售罄时调用
function tryReturnFail() {
  // 显示提示
  showToast('慢了一步，已售罄！');
  // 3 秒后再回传并关闭
  setTimeout(()=> safeReturn(600), 3000);//第一个数字代表秒数
}

    // 安全回传到主窗口并关闭自己
    function safeReturn(value) {
      if (window.__returned) return;
      window.__returned = true;

      if (window.opener && typeof window.opener.applyMiniGameResult === 'function') {
        try {
          window.opener.applyMiniGameResult(value);
        } catch(e) {}
      }
      // 3秒后关闭（保证提示能看清楚）
      setTimeout(()=> window.close(), 3000);
    }

    // ESC 放弃
    window.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape') {
        showToast('已放弃，本次失败');
        tryReturnFail();
      }
    });

    // 页面卸载兜底
    window.addEventListener('beforeunload', ()=>{
      if (!window.__returned) {
        tryReturnFail();
      }
    });
  </script>
</body>
</html>

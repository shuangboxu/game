<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>12306 æŠ¢ç¥¨</title>
  <meta name="viewport" content="width=500, initial-scale=1" />
  <style>
    :root {
      --blue: #1e80ff;
      --gray: #f5f7fa;
      --text: #2b2f36;
      --muted: #6b7280;
      --ok: #16a34a;
      --bad: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
      background: white; color: var(--text);
    }
    header {
      padding: 14px 16px; border-bottom: 1px solid #eef2f7; font-weight: 600;
    }
    .bar {
      display: flex; align-items: center; gap: 8px;
      padding: 12px 16px; background: var(--gray); font-size: 14px;
    }
    .pill { padding: 2px 8px; border-radius: 999px; background: white; border: 1px solid #e5e7eb; }
    .row {
      display: grid; grid-template-columns: 1fr auto auto auto; gap: 16px;
      padding: 16px; border-bottom: 1px solid #eef2f7; align-items: center;
    }
    .time { font-size: 22px; font-weight: 700; }
    .station { font-size: 12px; color: var(--muted); }
    .price { font-weight: 600; }
    .stock.ok { color: var(--ok); font-weight: 600; }
    .stock.bad { color: var(--bad); font-weight: 600; }
    .btn {
      padding: 10px 16px; border-radius: 8px; border: 0; background: var(--blue);
      color: white; cursor: pointer; font-weight: 600; font-size: 14px;
    }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }
    .hint { font-size: 12px; color: var(--muted); margin: 8px 16px 0; }
    .count { font-variant-numeric: tabular-nums; font-weight: 700; }
    .toast {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 16px; background: rgba(0,0,0,.8); color: #fff; padding: 10px 14px;
      border-radius: 8px; font-size: 14px; display: none;
    }
  </style>
</head>
<body>
  <header>12306 åˆ—è½¦æŸ¥è¯¢</header>

  <div class="bar">
    <span class="pill">æ”¾ç¥¨å€’è®¡æ—¶ï¼š<span id="cd" class="count">3</span>s</span>
    <span class="pill">è§„åˆ™ï¼šæ”¾ç¥¨åâ€œ<b>é¢„å®š</b>â€ä¼šå¯ç”¨ï¼Œè¯·å°½å¿«ç‚¹å‡»</span>
  </div>
  <div class="hint">æç¤ºï¼šæ…¢ 1~3 ç§’å¯èƒ½å°±ã€Œæ— ç¥¨ã€ï¼›æˆåŠŸä¼šæŠŠä½ çš„è€—æ—¶ï¼ˆç§’ï¼‰å›ä¼ ä¸»é¡µé¢ã€‚</div>

  <div class="row">
    <div>
      <div class="time">18:40 <span class="station">è¿‡ åŒ—äº¬è¥¿</span></div>
      <div class="time">19:06 <span class="station">ç»ˆ è‰¯ä¹¡</span></div>
    </div>
    <div class="price">ï¿¥6 <span class="station">èµ·</span></div>
    <div id="stock" class="stock ok">æ— åº§ æœ‰ç¥¨</div>
    <div>
      <button id="bookBtn" class="btn" disabled>é¢„å®š</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // é¡µé¢åŠ è½½å°±æç¤ºè§„åˆ™
   alert(
  "ğŸš„ã€12306 æŠ¢ç¥¨å¤§æˆ˜ã€‘\n\n" +
  "åœºæ™¯ï¼šåŒ—äº¬è¥¿ç«™ â†’ è‰¯ä¹¡ç«™ï¼Œé»„é‡‘è½¦æ¬¡ 18:40 - 19:06ã€‚\n" +
  "ç¥¨ä»·åªè¦ ï¿¥6ï¼Œä½†ä¸‹ç­é«˜å³°ï¼ŒæŠ¢ç¥¨çš„äººå±±äººæµ·ï¼\n\n" +
  "ç©æ³•ï¼š\n" +
  "- ç³»ç»Ÿä¼šåœ¨æ”¾ç¥¨æ—¶å¯ç”¨ã€é¢„å®šã€æŒ‰é’®\n" +
  "- ä½ å¿…é¡»ç¬¬ä¸€æ—¶é—´ç‚¹ä¸‹ã€é¢„å®šã€ï¼\n" +
  "- æ…¢ 1~3 ç§’ï¼Œç¥¨å¯èƒ½å°±è¢«åˆ«äººç§’å…‰\n\n" +
  "æç¤ºï¼š\n" +
  "æ‰‹é€Ÿä¸çœ¼åŠ›ï¼Œå°±æ˜¯ä½ èƒ½ä¸èƒ½ä¸Šç«è½¦çš„å…³é”®ï¼ğŸ”¥\n\n" +
  "å‡†å¤‡å¥½äº†å—ï¼Ÿ\n"
);

    // â€”â€” å¯è°ƒå‚æ•° â€”â€” //
    const PRE_OPEN_COUNTDOWN = 3;   // æ”¾ç¥¨å‰å€’è®¡æ—¶ç§’æ•°ï¼ˆå±•ç¤ºç”¨ï¼‰
    const SELL_OUT_AFTER_MIN = 0.8; // æ”¾ç¥¨åæœ€æ—©å”®ç½„(ç§’)
    const SELL_OUT_AFTER_MAX = 2.5; // æ”¾ç¥¨åæœ€æ™šå”®ç½„(ç§’)

    // â€”â€” è¿è¡ŒçŠ¶æ€ â€”â€” //
    let tStartOpen = null;      // æ”¾ç¥¨å¼€å§‹æ—¶åˆ»(ms)
    let soldOutAt = null;       // å”®ç½„çš„ç»å¯¹æ—¶é—´(ms)
    let opened = false;         // æ˜¯å¦å·²æ”¾ç¥¨
    const btn = document.getElementById('bookBtn');
    const stockEl = document.getElementById('stock');
    const cdEl = document.getElementById('cd');
    const toast = document.getElementById('toast');

    function showToast(msg) {
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(()=> toast.style.display='none', 1500);
    }

    // æ”¾ç¥¨å€’è®¡æ—¶
    let remain = PRE_OPEN_COUNTDOWN;
    cdEl.textContent = remain;
    const cdTimer = setInterval(()=>{
      remain--;
      cdEl.textContent = Math.max(0, remain);
      if (remain <= 0) {
        clearInterval(cdTimer);
        openSale();
      }
    }, 1000);

    function openSale() {
      opened = true;
      btn.disabled = false;
      tStartOpen = Date.now();
      // éšæœºä¸€ä¸ªå”®ç½„æ—¶é—´çª—å£
      const delta = (SELL_OUT_AFTER_MIN + Math.random() * (SELL_OUT_AFTER_MAX - SELL_OUT_AFTER_MIN)) * 1000;
      soldOutAt = tStartOpen + delta;

      // çœ‹é—¨äººï¼šåˆ°ç‚¹è‡ªåŠ¨å”®ç½„
      const checkTimer = setInterval(()=>{
        if (!opened) return clearInterval(checkTimer);
        if (Date.now() >= soldOutAt) {
          // è‡ªåŠ¨å”®ç½„
          toSoldOutUI();
          // å¦‚æœè¿˜æ²¡ç‚¹å°±å¤±è´¥ï¼Œè¿”å› 99999
          tryReturnFail();
          clearInterval(checkTimer);
        }
      }, 30);
    }

    function toSoldOutUI() {
      stockEl.textContent = 'æ— åº§ æ— ç¥¨';
      stockEl.classList.remove('ok');
      stockEl.classList.add('bad');
      btn.disabled = true;
    }

    // ç”¨æˆ·ç‚¹å‡»â€œé¢„å®šâ€
    btn.addEventListener('click', ()=>{
      if (!opened) return;
      const now = Date.now();
      if (now >= soldOutAt) {
        toSoldOutUI();
        showToast('æ…¢äº†ä¸€æ­¥ï¼Œå·²å”®ç½„ï¼');
        tryReturnFail();
        return;
      }
      // æˆåŠŸï¼šå›ä¼ è€—æ—¶ï¼ˆå‘ä¸Šå–æ•´ï¼‰
      const spentSec = Math.max(0, Math.ceil((now - tStartOpen) / 1000));
      showToast('é¢„å®šæˆåŠŸï¼Œè€—æ—¶ '+ spentSec +' ç§’');
      safeReturn(spentSec);
    });

    // å¤±è´¥å›ä¼ 
// è‡ªåŠ¨å”®ç½„æ—¶è°ƒç”¨
function tryReturnFail() {
  // æ˜¾ç¤ºæç¤º
  showToast('æ…¢äº†ä¸€æ­¥ï¼Œå·²å”®ç½„ï¼');
  // 3 ç§’åå†å›ä¼ å¹¶å…³é—­
  setTimeout(()=> safeReturn(600), 3000);//ç¬¬ä¸€ä¸ªæ•°å­—ä»£è¡¨ç§’æ•°
}

    // å®‰å…¨å›ä¼ åˆ°ä¸»çª—å£å¹¶å…³é—­è‡ªå·±
    function safeReturn(value) {
      if (window.__returned) return;
      window.__returned = true;

      if (window.opener && typeof window.opener.applyMiniGameResult === 'function') {
        try {
          window.opener.applyMiniGameResult(value);
        } catch(e) {}
      }
      // 3ç§’åå…³é—­ï¼ˆä¿è¯æç¤ºèƒ½çœ‹æ¸…æ¥šï¼‰
      setTimeout(()=> window.close(), 3000);
    }

    // ESC æ”¾å¼ƒ
    window.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape') {
        showToast('å·²æ”¾å¼ƒï¼Œæœ¬æ¬¡å¤±è´¥');
        tryReturnFail();
      }
    });

    // é¡µé¢å¸è½½å…œåº•
    window.addEventListener('beforeunload', ()=>{
      if (!window.__returned) {
        tryReturnFail();
      }
    });
  </script>
</body>
</html>
